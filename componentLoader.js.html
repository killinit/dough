<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: lib/componentLoader.js</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"default":{"outputSourceFiles":true},"monospaceLinks":false,"cleverLinks":true,"applicationName":"Dough JavaScript","copyright":"Copyright Money Advice Service &copy;","linenums":true,"collapseSymbols":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Dough JavaScript</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="module:Collapsable~Collapsable">
            <span class="title">
                <a href="module-Collapsable-Collapsable.html">module:Collapsable~Collapsable</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:Collapsable~Collapsable#_setupAccessibility"><a href="module-Collapsable-Collapsable.html#_setupAccessibility">_setupAccessibility</a></li>
            
                <li data-name="module:Collapsable~Collapsable#handleUIEventTracking"><a href="module-Collapsable-Collapsable.html#handleUIEventTracking">handleUIEventTracking</a></li>
            
                <li data-name="module:Collapsable~Collapsable#init"><a href="module-Collapsable-Collapsable.html#init">init</a></li>
            
                <li data-name="module:Collapsable~Collapsable#setListeners"><a href="module-Collapsable-Collapsable.html#setListeners">setListeners</a></li>
            
                <li data-name="module:Collapsable~Collapsable#setTargetTrackingListeners"><a href="module-Collapsable-Collapsable.html#setTargetTrackingListeners">setTargetTrackingListeners</a></li>
            
                <li data-name="module:Collapsable~Collapsable#toggle"><a href="module-Collapsable-Collapsable.html#toggle">toggle</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:DoughBaseComponent~DoughBaseComponent">
            <span class="title">
                <a href="module-DoughBaseComponent-DoughBaseComponent.html">module:DoughBaseComponent~DoughBaseComponent</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent.extend"><a href="module-DoughBaseComponent-DoughBaseComponent.html#extend">extend</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#_bindUiEvents"><a href="module-DoughBaseComponent-DoughBaseComponent.html#_bindUiEvents">_bindUiEvents</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#_initialisedFailure"><a href="module-DoughBaseComponent-DoughBaseComponent.html#_initialisedFailure">_initialisedFailure</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#_initialisedSuccess"><a href="module-DoughBaseComponent-DoughBaseComponent.html#_initialisedSuccess">_initialisedSuccess</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#_unbindUiEvents"><a href="module-DoughBaseComponent-DoughBaseComponent.html#_unbindUiEvents">_unbindUiEvents</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#destroy"><a href="module-DoughBaseComponent-DoughBaseComponent.html#destroy">destroy</a></li>
            
                <li data-name="module:DoughBaseComponent~DoughBaseComponent#setElement"><a href="module-DoughBaseComponent-DoughBaseComponent.html#setElement">setElement</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:FieldHelpText~FieldHelpText">
            <span class="title">
                <a href="module-FieldHelpText-FieldHelpText.html">module:FieldHelpText~FieldHelpText</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:FieldHelpText~FieldHelpText#_addAccessibility"><a href="module-FieldHelpText-FieldHelpText.html#_addAccessibility">_addAccessibility</a></li>
            
                <li data-name="module:FieldHelpText~FieldHelpText#_addListeners"><a href="module-FieldHelpText-FieldHelpText.html#_addListeners">_addListeners</a></li>
            
                <li data-name="module:FieldHelpText~FieldHelpText#_onBlur"><a href="module-FieldHelpText-FieldHelpText.html#_onBlur">_onBlur</a></li>
            
                <li data-name="module:FieldHelpText~FieldHelpText#hideTooltip"><a href="module-FieldHelpText-FieldHelpText.html#hideTooltip">hideTooltip</a></li>
            
                <li data-name="module:FieldHelpText~FieldHelpText#init"><a href="module-FieldHelpText-FieldHelpText.html#init">init</a></li>
            
                <li data-name="module:FieldHelpText~FieldHelpText#showTooltip"><a href="module-FieldHelpText-FieldHelpText.html#showTooltip">showTooltip</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:RangeInput~RangeInput">
            <span class="title">
                <a href="module-RangeInput-RangeInput.html">module:RangeInput~RangeInput</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:RangeInput~RangeInput#_cloneElements"><a href="module-RangeInput-RangeInput.html#_cloneElements">_cloneElements</a></li>
            
                <li data-name="module:RangeInput~RangeInput#_setupSyncInputs"><a href="module-RangeInput-RangeInput.html#_setupSyncInputs">_setupSyncInputs</a></li>
            
                <li data-name="module:RangeInput~RangeInput#init"><a href="module-RangeInput-RangeInput.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:TabSelector~TabSelector">
            <span class="title">
                <a href="module-TabSelector-TabSelector.html">module:TabSelector~TabSelector</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:TabSelector~TabSelector#_checkComponentMarkup"><a href="module-TabSelector-TabSelector.html#_checkComponentMarkup">_checkComponentMarkup</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_convertLinksToButtons"><a href="module-TabSelector-TabSelector.html#_convertLinksToButtons">_convertLinksToButtons</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_deSelectItem"><a href="module-TabSelector-TabSelector.html#_deSelectItem">_deSelectItem</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_focusTarget"><a href="module-TabSelector-TabSelector.html#_focusTarget">_focusTarget</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_handleClickEvent"><a href="module-TabSelector-TabSelector.html#_handleClickEvent">_handleClickEvent</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_haveTriggersWrapped"><a href="module-TabSelector-TabSelector.html#_haveTriggersWrapped">_haveTriggersWrapped</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_positionMenu"><a href="module-TabSelector-TabSelector.html#_positionMenu">_positionMenu</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_setTriggerWrapperHeight"><a href="module-TabSelector-TabSelector.html#_setTriggerWrapperHeight">_setTriggerWrapperHeight</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_setupAccessibility"><a href="module-TabSelector-TabSelector.html#_setupAccessibility">_setupAccessibility</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_subscribeHubEvents"><a href="module-TabSelector-TabSelector.html#_subscribeHubEvents">_subscribeHubEvents</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_toggleMenu"><a href="module-TabSelector-TabSelector.html#_toggleMenu">_toggleMenu</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_updateCollapsedState"><a href="module-TabSelector-TabSelector.html#_updateCollapsedState">_updateCollapsedState</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_updateTargets"><a href="module-TabSelector-TabSelector.html#_updateTargets">_updateTargets</a></li>
            
                <li data-name="module:TabSelector~TabSelector#_updateTriggers"><a href="module-TabSelector-TabSelector.html#_updateTriggers">_updateTriggers</a></li>
            
                <li data-name="module:TabSelector~TabSelector#init"><a href="module-TabSelector-TabSelector.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:TabularTooltip~TabularTooltip">
            <span class="title">
                <a href="module-TabularTooltip-TabularTooltip.html">module:TabularTooltip~TabularTooltip</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:TabularTooltip~TabularTooltip#init"><a href="module-TabularTooltip-TabularTooltip.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="module:Validation~Validation">
            <span class="title">
                <a href="module-Validation-Validation.html">module:Validation~Validation</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="module:Validation~Validation#_addAccessibility"><a href="module-Validation-Validation.html#_addAccessibility">_addAccessibility</a></li>
            
                <li data-name="module:Validation~Validation#_getErrorIndexByName"><a href="module-Validation-Validation.html#_getErrorIndexByName">_getErrorIndexByName</a></li>
            
                <li data-name="module:Validation~Validation#_getFieldGroup"><a href="module-Validation-Validation.html#_getFieldGroup">_getFieldGroup</a></li>
            
                <li data-name="module:Validation~Validation#_getFieldGroupValidity"><a href="module-Validation-Validation.html#_getFieldGroupValidity">_getFieldGroupValidity</a></li>
            
                <li data-name="module:Validation~Validation#_getInlineErrorID"><a href="module-Validation-Validation.html#_getInlineErrorID">_getInlineErrorID</a></li>
            
                <li data-name="module:Validation~Validation#_handleBlurEvent"><a href="module-Validation-Validation.html#_handleBlurEvent">_handleBlurEvent</a></li>
            
                <li data-name="module:Validation~Validation#_handleChangeEvent"><a href="module-Validation-Validation.html#_handleChangeEvent">_handleChangeEvent</a></li>
            
                <li data-name="module:Validation~Validation#_handleSubmit"><a href="module-Validation-Validation.html#_handleSubmit">_handleSubmit</a></li>
            
                <li data-name="module:Validation~Validation#_hideValidationSummary"><a href="module-Validation-Validation.html#_hideValidationSummary">_hideValidationSummary</a></li>
            
                <li data-name="module:Validation~Validation#_prepareFieldGroupValidity"><a href="module-Validation-Validation.html#_prepareFieldGroupValidity">_prepareFieldGroupValidity</a></li>
            
                <li data-name="module:Validation~Validation#_prepareMarkup"><a href="module-Validation-Validation.html#_prepareMarkup">_prepareMarkup</a></li>
            
                <li data-name="module:Validation~Validation#_removeAccessibility"><a href="module-Validation-Validation.html#_removeAccessibility">_removeAccessibility</a></li>
            
                <li data-name="module:Validation~Validation#_showValidationSummary"><a href="module-Validation-Validation.html#_showValidationSummary">_showValidationSummary</a></li>
            
                <li data-name="module:Validation~Validation#_sortErrorsByFieldDisplayOrder"><a href="module-Validation-Validation.html#_sortErrorsByFieldDisplayOrder">_sortErrorsByFieldDisplayOrder</a></li>
            
                <li data-name="module:Validation~Validation#_validateMax"><a href="module-Validation-Validation.html#_validateMax">_validateMax</a></li>
            
                <li data-name="module:Validation~Validation#_validateMin"><a href="module-Validation-Validation.html#_validateMin">_validateMin</a></li>
            
                <li data-name="module:Validation~Validation#_validateMinLength"><a href="module-Validation-Validation.html#_validateMinLength">_validateMinLength</a></li>
            
                <li data-name="module:Validation~Validation#_validatePattern"><a href="module-Validation-Validation.html#_validatePattern">_validatePattern</a></li>
            
                <li data-name="module:Validation~Validation#_validateRequired"><a href="module-Validation-Validation.html#_validateRequired">_validateRequired</a></li>
            
                <li data-name="module:Validation~Validation#addError"><a href="module-Validation-Validation.html#addError">addError</a></li>
            
                <li data-name="module:Validation~Validation#checkfieldGroupValidity"><a href="module-Validation-Validation.html#checkfieldGroupValidity">checkfieldGroupValidity</a></li>
            
                <li data-name="module:Validation~Validation#refreshInlineErrors"><a href="module-Validation-Validation.html#refreshInlineErrors">refreshInlineErrors</a></li>
            
                <li data-name="module:Validation~Validation#refreshValidationSummary"><a href="module-Validation-Validation.html#refreshValidationSummary">refreshValidationSummary</a></li>
            
                <li data-name="module:Validation~Validation#removeError"><a href="module-Validation-Validation.html#removeError">removeError</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="componentLoader.js.html">Source: lib/componentLoader.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * UI component loader. Scans the supplied DOM for 'data-dough-component' attributes and initialises
 * components based on those attribute values
 *
 * The following markup will cause two components to be initialised, DropdownList and MultiToggler:
 *
 *     &lt;div class="container">
 *       &lt;div data-dough-component="DropdownList">&lt;/div>
 *       &lt;div data-dough-component="MultiToggler">&lt;/div>
 *     &lt;/div>
 *
 * Components are created in two separate passes. The reason for this is so that all components can
 * have a chance to set up listeners to any other components they need. Once they are all created,
 * they are initialised (the `init` method of each is called) in a second pass.
 *
 * @module componentLoader
 * @returns {Function} componentLoader
 */
define(['jquery', 'rsvp'], function($, RSVP) {

  'use strict';

  return {

    /**
     * Stores Each key will store a component name and an array of
     * instances of that component type.
     * @attribute
     * @type {Object}
     */
    components: {},

    /**
     * Create components based on the supplied DOM fragment
     * @param {jQuery} [$container] - Uses `$('body')` if not supplied.
     * @param {Boolean} [includeDeferred] - Includes deferred objects when initialising components.
     * Deferred objects can be specified for later instantiation by specifying `data-dough-defer` on the HTML element.
     * @returns {Object} - a promise that will resolve or reject depending on whether all modules
     * initialised successfully
     */
    init: function($container, includeDeferred) {
      var componentsToCreate,
          instantiatedList,
          initialisedList,
          self = this,
          promises;

      this.components = {};
      // if no DOM fragment supplied, use the `&lt;body>` tag
      $container = $container || $('body');
      componentsToCreate = this._listComponentsToCreate($container, includeDeferred || false);
      instantiatedList = this._createPromises(componentsToCreate);
      initialisedList = this._createPromises(componentsToCreate);
      if (componentsToCreate.length) {
        this._instantiateComponents(componentsToCreate, instantiatedList.deferreds);
        // Wait until all components are instantiated before initialising them in a second pass
        RSVP.allSettled(instantiatedList.promises).then(function(results) {
          self._checkForFailedInstantiations(results, initialisedList.deferreds);
          self._initialiseComponents(self.components, initialisedList.deferreds);
        });
      }
      promises = RSVP.allSettled(initialisedList.promises);
      promises.then(function() {
        $('body').attr('data-dough-component-loader-all-loaded', 'yes');
      });
      return promises;
    },

    _checkForFailedInstantiations: function(results, initialisedList) {
      $.each(results, function(idx, obj) {
        if ((obj.state === 'rejected') &amp;&amp; (obj.reason.description === 'SINGLETON-DUPLICATE')) {
          initialisedList[idx].resolve();
          initialisedList.splice(idx, 1);
        }
      });
    },

    /**
     * Make an array of objects, each containing pointers to a component container and name
     * @param {Object} $container
     * @param {Boolean} [includeDeferred] - Includes deferred objects when initialising components
     * @returns {Array}
     */
    _listComponentsToCreate: function($container, includeDeferred) {
      var componentsToCreate = [],
          $els,
          $el,
          attrs,
          selector = '[data-dough-component]';

      if (!includeDeferred) {
        selector += ':not([data-dough-defer])';
      }

      $els = $container.is(selector)? $container : $container.find(selector);
      $els.each(function() {
        $el = $(this);
        attrs = $el.attr('data-dough-component').split(' ');
        $.each(attrs, function(idx, val) {
          if (!$el.is('[data-dough-' + val + '-initialised="yes"]')) {
            componentsToCreate.push({
              $el: $el,
              componentName: val
            });
          }
        });
      });
      return componentsToCreate;
    },

    /**
     * Create a hash of deferreds and their associated promise properties (useful for passing to a
     * 'master' deferred for resolution)
     * @param {Array} componentsToCreate
     * @returns {{deferreds: Array, promises: Array}}
     */
    _createPromises: function(componentsToCreate) {
      var obj = {
        deferreds: [],
        promises: []
      };

      $.each(componentsToCreate, function(idx) {
        obj.deferreds.push(RSVP.defer());
        obj.promises.push(obj.deferreds[idx].promise);
      });
      return obj;
    },

    /**
     * Instantiate all components
     * @param {Array} componentsToCreate
     * @param {Array} instantiatedList - array of deferreds, one to be assigned to each new
     * component
     */
    _instantiateComponents: function(componentsToCreate, instantiatedList) {
      var self = this;
      $.each(componentsToCreate, function(idx, componentData) {
        self._instantiateComponent(componentData.componentName, componentData.$el, instantiatedList[idx]);
      });
    },

    /**
     * Instantiate an individual component
     * @param {string} componentName
     * @param {object} $el
     * @param {object} instantiated - a deferred, to be resolved after each component is required /
     * instantiated, which may be async, hence the use of a deferred
     */
    _instantiateComponent: function(componentName, $el, instantiated) {
      var self = this,
          config = this._parseConfig($el, componentName);

      require([componentName], function(Constr) {
        if (!Constr.isSingleton || !self.components[componentName]) {
          config.componentName = componentName;
          if (!self.components[componentName]) {
            self.components[componentName] = [];
          }
          self.components[componentName].push(new Constr($el, config));
          instantiated.resolve();
        } else {
          instantiated.reject({
            componentName: componentName,
            description: 'SINGLETON-DUPLICATE'
          });
        }
      });
    },

    /**
     * The second pass - all components have been instantiated, so now call init() on each. This
     * has given all components a chance to subscribe to events from other components, before they
     * are initialised. If one component errors, catch it so others to initialise
     * @param {object} components - a hash of component names and arrays of instances
     * @param {array} initialisedList - list of promises, one to pass to each component so it can
     * indicate when it has initialised (it might need to conduct async activity to do so, so it's
     * not enough to just set a flag after the constructor is called)
     */
    _initialiseComponents: function(components, initialisedList) {
      var i = 0;

      $.each(components, function(componentName, list) {
        $.each(list, function(idx, instance) {
          try {
            instance.init &amp;&amp; instance.init(initialisedList[i]);
          } catch (err) {
            initialisedList[i].reject(err);
          }
          i++;
        });
      });
    },

    /**
     * Extract any config from the DOM for a given component
     * @param {jQuery} $el - component container
     * @param {string} componentName
     * @returns {object} - parsed JSON config or empty object
     */
    _parseConfig: function($el, componentName) {
      var config = $el.attr('data-dough-' + this._convertComponentNameToDashed(componentName) + '-config');
      try {
        config = JSON.parse(config);
      } catch (err) {
        config = {};
      }
      return config;
    },

    /**
     * Converts camelcase component name to dashed
     * @param {string} componentName eg. TabSelector
     * @returns {string} eg. tab-selector
     */
    _convertComponentNameToDashed: function(componentName) {
      var val = componentName.replace(/([A-Z])/g, function($1) {
        return '-' + $1.toLowerCase();
      });
      return val.substr(1);
    }

  };

});
</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Mon May 11 2015 10:09:07 GMT+0000 (UTC)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
